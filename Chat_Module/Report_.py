from DataBase_Modules.DataBase import *

from Chat_Module.AI_Report import Kimi_Chat

# 这边就算初步尝试生成报告的模块
# 首先连接数据库，然后选择所要分析的检测结果数据
# 接着按照预先写好的提示词去问kimi，然后将kimi的回复输出为pdf
# 但是pdf的序号格式可能还是有问题，后续我看搞一套回复的模板给kimi
if __name__ == '__main__':
    db = DataBase("localhost", "root", "123456", "new_table",
                  mysql_path='/usr/bin/mysql',
                  mysqldump_path='/usr/bin/mysqldump')

    kimi = Kimi_Chat('./test.md')

    results = db.Infer_Result_Extra([i for i in range(24, 59)])
    # exit(0)

    ####  这边可以搞几个用户的输入框，让他们选择性地输入信息
    # utils_msg = input('请输入生产环境的设备信息，若无则输入-1：')
    # product_msg = input('请输入生产过程的产品信息，若无则输入-1：')
    # staff_msg = input('请输入生产过程的人员信息，若无则输入-1：')
    # craft_msg = input('请输入生产过程的工艺信息，若无则输入-1：')
    # other_msg = input('请输入生产过程中的其他信息，若无则输入-1：')

    utils_msg = "包括点焊机和弧焊机。点焊机适用于薄钢板焊接，形成均匀焊点；弧焊机用于较厚部位焊接，如防撞梁与车门内板连接"
    product_msg = "汽车车门钢材一般采用高强度钢、热轧钢板、冷轧钢板、镀锌钢板等。高强度钢具有高强韧性，减轻重量同时保证结构强度；热轧钢板和冷轧钢板成形性和加工性能良好；镀锌钢板耐腐蚀性好"
    staff_msg = "设备操作人员：负责操作冲压、焊接、涂装等设备。需具备熟练操作技能和丰富经验，准确控制设备运行参数，确保生产顺利进行"
    craft_msg = "焊接工艺：将冲压成型后的钢材部件进行焊接，形成完整车门结构。选择合适焊接方法和参数，确保焊缝质量和强度"
    other_msg = "无"

    # 创建一个字典来存储信息
    info_dict = {
        "生产环境的设备信息": utils_msg,
        "生产过程的产品信息": product_msg,
        "生产过程的人员信息": staff_msg,
        "生产过程的工艺信息": craft_msg,
        "生产过程中的其他信息": other_msg
    }

    # 过滤掉值为 '-1' 的信息
    filtered_info = {key: value for key, value in info_dict.items() if value != '-1'}

    # 构建提示词
    additional_info = "\n".join([f"- **{key}**: {value}" for key, value in filtered_info.items()])
    if len(additional_info) == 0:
        additional_info = "无"

    prompt = f"""
# 缺陷检测报告生成任务

## 背景信息
你正在为一个缺陷检测任务生成一份专业的检测报告。以下是本次检测任务中提取的关键数据，请根据这些数据生成一份详细的分析报告。

## 检测结果数据
以下是本次缺陷检测任务中提取的核心信息：
- **缺陷类型**: {results[0]}  
  （检测到的缺陷种类及其分类结果）

- **每种缺陷出现的次数**: {results[1]}  
  （每种缺陷在检测样本中的出现频次）

- **每种缺陷归一化后的中心点平均位置**: {results[2]}  
  （每种缺陷区域的几何中心点在图像中的归一化坐标平均值，范围为 [0, 1]）

- **每种缺陷区域归一化后的平均长和宽**: {results[3]}  
  （每种缺陷区域的边界框在图像中的归一化宽度和高度平均值，范围为 [0, 1]）

- **每种缺陷中心点的标准差**: {results[4]}  
  （每种缺陷中心点分布的标准差，用于衡量中心点位置的离散程度）

- **每种缺陷的平均面积占比 (缺陷面积 / 图片面积)**: {results[5]}  
  （每种缺陷区域面积占整张图像面积的比例，范围为 [0, 1])

- **每种缺陷的面积标准差**: {results[6]}  
  （每种缺陷面积占比的标准差，用于衡量每种面积分布的离散程度）

- **不同时间段内缺陷的出现情况**: {results[7]}  
  （缺陷在不同时间段内的出现频率）

## 其他信息
{additional_info}

## 报告要求
请根据上述数据完成以下任务：
1. **数据分析与总结**:
   - 分析每种缺陷的分布特点（如位置、大小、面积占比等）。
   - 对比不同时间段内的缺陷分布情况，分析是否存在时间上的规律性。
   - 总结缺陷的主要特征及其可能的原因。

2. **改进建议**:
   - 基于以上的数据，提供详细的改进建议，包括但不限于：对生产设备的使用与维护、产品的改进、人员培训、工艺改良等。（要求每条建议不少于150字）

3. **总结与结论**:
   - 根据以上的所有信息与分析结果，进行归纳和总结，为现实场景中的生产和决策提供优化建议。

## 格式要求
   - 对于缺陷检测报告，请你严格根据以下的格式来输出报告内容：
   # 缺陷检测报告
   ## 1. 数据分析与总结
   ### 1.1 缺陷分布特点分析
   ## 1.1.1 位置分布
"""

    # print(prompt)
    kimi.chat(prompt)
    kimi.save_to_markdown()
    kimi.convert_to_pdf(pdf_file='new.pdf')

    # 从目前的报告来看，对于缺陷信息的分析足够充分，但是对于进一步的改进建议的篇幅还有待增加
    # 如果要增加这部分的篇幅，目前的想法有：
    # 1、改进prompt提示词，让模型从：生产环境、人员等多个角度进行分析
    # 2、增加一些其他信息，比如：生产环境的信息（如设备型号、规格、产品信息）、人员信息（如人员数量、人员分布、人员技能等）
